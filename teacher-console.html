<!DOCTYPE html>
<html>
<head lang="en">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <meta charset="UTF-8">
    <title>Teacher console</title>
	<style>
		#feedback { font-size: 1.4em; }
		#lobbyVideogrid .ui-selecting { border: solid 2px #FECA40; }
		#lobbyVideogrid .ui-selected { border: solid 2px #F39814; }
		#lobbyVideogrid { list-style-type: none; margin: 0; padding: 0; width: 1000px; }
		#lobbyVideogrid li { margin: 3px; padding: 1px; float: left; width: 160px; height: 90px; }
		#lobbyVideogrid li video { margin:0px; padding:0px; width: 160px; height: 90px; }
		
	</style>
      <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://jitsi.expertcollege.com/libs/lib-jitsi-meet.min.js"></script>
    <script src="common.js?v=1"></script>
    <script>
		let params = new URLSearchParams(location.search);
		let paramName = (params.has('id') ? params.get('id') : Math.floor(Math.random() * 10000))
		let displayName = TEACHER_PREFIX + paramName + CONSOLE_SUFFIX;
		let lobby = null;
		let room = null;
		let joinedToRoom = false;
		let connection = null;
		let peersTree = [];

		function onLobbyJoined() {
		    console.log('joined lobby successfully!');                                         
		}
		
		function onUserJoinedLobby(id, user) {
			var nameparts = user.getDisplayName().split('/');

			if (peersTree[nameparts[0]] == undefined) {
				peersTree[nameparts[0]] = [];
			}
			if (peersTree[nameparts[0]][nameparts[1]] == undefined) {
				peersTree[nameparts[0]][nameparts[1]] = [];
			}

			peersTree[nameparts[0]][nameparts[1]][nameparts[2]] = user;
            console.log(`User ${id} (${user.getDisplayName()}) joined the lobby`);   

		}
	    
	    function onUserLeftLobby(id, user) {
            var nameparts = user.getDisplayName().split('/');
			peersTree[nameparts[0]][nameparts[1]][nameparts[2]] = undefined;

            console.log(`User ${id} (${user.getDisplayName()}) left the lobby`);   
		}
		
		function onConnectionFailed() {
			console.error('Connection Failed!');
		}  
		
		function onConnectionSuccess() {
		    console.log('conncection successfull!');
		    lobby = connection.initJitsiConference(ROOM_LOBBY, confOptions);
		    lobby.on(JitsiMeetJS.events.conference.USER_JOINED, onUserJoinedLobby);
		    lobby.on(JitsiMeetJS.events.conference.USER_LEFT, onUserLeftLobby);
		    lobby.on(JitsiMeetJS.events.conference.CONFERENCE_JOINED, onLobbyJoined);			
		    lobby.on(JitsiMeetJS.events.conference.TRACK_ADDED, onRemoteTrackAdded);
		    lobby.on(JitsiMeetJS.events.conference.TRACK_REMOVED, onRemoteTrackRemoved);
			lobby.setDisplayName(displayName);
		    lobby.join();        
		}
		
		function onRemoteTrackAdded(track) {
		    if (!track.isLocal() && track.getType() === 'video') {
				const participantId = track.getParticipantId(); 
		        const remoteUser = lobby.getParticipantById(participantId);
				
				//only add experience room streams
				if (remoteUser.getDisplayName().startsWith(ER_PREFIX)) {
					console.log(`adding video track from ${participantId} to lobby`);
                    $('#lobbyVideogrid').append(`<li class="ui-state-default" data-participant="${participantId}" data-displayname="${remoteUser.getDisplayName()}"><video id="lobbyVid${participantId}" autoplay></video></li>`);
					track.attach(document.getElementById(`lobbyVid${participantId}`));
				}
			}			
		}
		
		function onRemoteTrackRemoved(track) {
			if (!track.isLocal() && track.getType() === 'video') {
				const participantId = track.getParticipantId(); 
		        const remoteUser = lobby.getParticipantById(participantId);
				
				if (!remoteUser || remoteUser.getDisplayName().startsWith(ER_PREFIX)) {
					 console.log(`removing video track from ${participantId} from lobby`);
					 var video = document.getElementById(`lobbyVid${participantId}`);
					 track.detach(video);
					 video.parentNode.remove();
				}
			}
		}
		
		function createRoom(name, invitedIds) {
		    room = connection.initJitsiConference(name, confOptions);
		    room.on(JitsiMeetJS.events.conference.CONFERENCE_JOINED, onRoomJoined);
		    room.on(JitsiMeetJS.events.conference.CONFERENCE_LEFT, onRoomLeft);            
		    room.on(JitsiMeetJS.events.conference.USER_JOINED, onUserJoined);
		    room.on(JitsiMeetJS.events.conference.USER_LEFT, onUserLeft);
		    room.on(JitsiMeetJS.events.conference.DISPLAY_NAME_CHANGED, (userID, displayName) => console.log(`${userID} - ${displayName}`));
			room.setDisplayName(displayName);
		    room.join();
			
			//send invite to peers through lobby channel
			for (var i = 0; i < invitedIds.length; i++) {
                lobby.sendEndpointMessage(invitedIds[i], { command: CMD_JOIN_ROOM, values: { room: name }});
		    }
		}
		
		function onRoomJoined() {
			joinedToRoom = true;          
			document.getElementById('shareScreenBtn').disabled = false;
		}
		
		function onRoomLeft() {
			joinedToRoom = false;
			document.getElementById('shareScreenBtn').disabled = true;        
		}
		
		
		function onUserJoined(id, user) {
			
		}
		
		function onUserLeft(id) {
		}
		
		function shareScreen() {
			JitsiMeetJS.createLocalTracks({ devices: [ 'desktop'] }).then(
				tracks => { 
					for (var i = 0; i < tracks.length; i++) {
						room.addTrack(tracks[i]); 
					}
				});
		}
		
		function connectToRoom() {
            const usersToInvite = [];
			//include selected video feeds participant, and all related components (so experienceroom/<selected item>/*)
			$('#lobbyVideogrid li.ui-selected').each((_, item) => {
				const nameParts = item.dataset.displayname.split('/');
				const tree = peersTree[nameParts[0]][nameParts[1]];

				for (const user in tree) {
					if (!usersToInvite.includes(tree[user].getId())) {
						usersToInvite.push(tree[user].getId());
					}
                }
			});

			//also include own components (so teacher/<my id>/*)
            const nameParts = displayName.split('/');
            const tree = peersTree[nameParts[0]][nameParts[1]];
			for (const user in tree) {
				if (!tree[user].getDisplayName() == displayName && !usersToInvite.includes(tree[user].getId())) {
                    usersToInvite.push(tree[user].getId());
                }
			}

            createRoom(paramName, usersToInvite);
		}
		
		function disconnect() {
			console.log('disconnecting');
			connection.removeEventListener(JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED, onConnectionSuccess);
			connection.removeEventListener(JitsiMeetJS.events.connection.CONNECTION_FAILED, onConnectionFailed);
			connection.removeEventListener(JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED, disconnect);
		}

        function unload() {
            if (room) room.leave();
            if (lobby) lobby.leave();
            if (connection) connection.disconnect();
        }
		
		JitsiMeetJS.init();		
		connection = new JitsiMeetJS.JitsiConnection(null, null, connOptions);
		connection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED, onConnectionSuccess);
		connection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_FAILED, onConnectionFailed);
		connection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED, disconnect);
		connection.connect();
		
		
		$(function() {
			$("#lobbyVideogrid").selectable();
			$("#roomPage").hide();
		});
  </script>
</head>
<body>
  <div id="lobbyPage" onunload="unload();">
  	<ol id="lobbyVideogrid"></ol>
	<button id="connectButton" type='button' onclick='connectToRoom()'>Connect to selected rooms</button>
  </div>
  <div id="roomPage">
	<button id='shareScreenBtn' type='button' onclick='shareScreen()' disabled>share screen</button>
  </div>
</body>
<html>

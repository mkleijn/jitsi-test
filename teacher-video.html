<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Teacher video screen</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://jitsi.expertcollege.com/libs/lib-jitsi-meet.min.js"></script> <!-- low level api -->
    <script src='https://jitsi.expertcollege.com/external_api.js'></script> <!-- iframe api -->
    <script src="common.js?v=3"></script>
    <script>
        let params = new URLSearchParams(location.search);
        let displayName = TEACHER_PREFIX + (params.has('id') ? params.get('id') : Math.floor(Math.random() * 10000)) + VIDEOSCREEN_SUFFIX;
        let lobby = null;
        let lobbyConnection = null;
        let localTracks = null;
        let room = null;

        function onLobbyConnectionFailed() {
            console.error('Lobby Connection Failed!');
        }

        function onLobbyConnectionSuccess() {
            console.log('conncection successfull!');
            lobby = lobbyConnection.initJitsiConference(ROOM_LOBBY, confOptions);
            lobby.on(JitsiMeetJS.events.conference.CONFERENCE_JOINED, onLobbyJoined);
            lobby.on(JitsiMeetJS.events.conference.ENDPOINT_MESSAGE_RECEIVED, onLobbyMessageReceived);
            lobby.setDisplayName(displayName);
            lobby.join();
        }

        function onLobbyDisconnect() {
            console.log('disconnecting from lobby');
            lobbyConnection.removeEventListener(JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED, onLobbyConnectionSuccess);
            lobbyConnection.removeEventListener(JitsiMeetJS.events.connection.CONNECTION_FAILED, onLobbyConnectionFailed);
            lobbyConnection.removeEventListener(JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED, onLobbyDisconnect);
        }


        function onLobbyJoined() {
            lobby.setSenderVideoConstraint(RES_THUMBNAIL);
            for (var i = 0; i < localTracks.length; i++) {
                if (localTracks[i].getType() === 'video') {
                    lobby.addTrack(localTracks[i]);
                }
            }
        }

        function onLobbyMessageReceived(from, message) {
            if (message && message.command === CMD_JOIN_ROOM) {
                joinRoom(message.values.room);
            }
        }

        function joinRoom(name) {
            if (room) room.dispose();
            room = new JitsiMeetExternalAPI(JITSI_DOMAIN, {
                roomName: name,
                width: '100%',
                height: '100%',
                parentNode: document.body,
                configOverwrite: initOptions
            });
        }


        function unload() {
            for (let i = 0; i < localTracks.length; i++) {
                localTracks[i].dispose();
            }

            if (room) room.dispose();
            if (lobby) lobby.leave();
            if (lobbyConnection) lobbyConnection.disconnect();
        }


        JitsiMeetJS.init();
        JitsiMeetJS.setLogLevel(JitsiMeetJS.logLevels.ERROR);

        lobbyConnection = new JitsiMeetJS.JitsiConnection(null, null, connOptions);
        lobbyConnection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED, onLobbyConnectionSuccess);
        lobbyConnection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_FAILED, onLobbyConnectionFailed);
        lobbyConnection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED, onLobbyDisconnect);

        JitsiMeetJS.createLocalTracks({
            devices: ['audio', 'video'],
            resolution: 1080,
            constraints: {
                video: {
                    height: {
                        ideal: 1080,
                        max: 1080,
                        min: 240
                    }
                }
            }
        }).then(tracks => {
            localTracks = tracks;
            lobbyConnection.connect();
            roomConnection.connect();
        }).catch(error => {
            throw error;
        });
    </script>
</head>
<body onunload="unload();">
</body>
</html>
